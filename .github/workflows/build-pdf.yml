name: Build PDF (WeasyPrint with Noto CJK)

on:
  push:
    branches: [ main ]
    paths:
      - "index.md"
      - "AITL_Strategy_Proposal_Draft_v3.md"
      - "assets/css/**"
      - "_config.yml"
      - ".github/workflows/build-pdf.yml"
  workflow_dispatch:

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps (WeasyPrint & Japanese fonts)
        run: |
          sudo apt-get update
          sudo apt-get install -y weasyprint fonts-noto-cjk fonts-noto-color-emoji

      - name: Build site with Jekyll (same as GitHub Pages)
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: Ensure Figures dir
        run: mkdir -p Figures

      - name: Render Proposal â†’ PDF
        run: |
          INPUT_HTML="_site/AITL_Strategy_Proposal_Draft_v3.html"
          if [ ! -f "$INPUT_HTML" ]; then
            INPUT_HTML="_site/index.html"
          fi
          weasyprint "$INPUT_HTML" "Figures/AITL_Strategy_Proposal_Draft_v3.pdf"

      - name: Commit PDF
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Figures/AITL_Strategy_Proposal_Draft_v3.pdf
          if git commit -m "Update PDF (WeasyPrint, Noto CJK)"; then
            git push
          else
            echo "No PDF changes to commit."
          fi
