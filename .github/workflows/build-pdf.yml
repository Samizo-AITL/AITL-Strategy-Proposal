name: Build PDF (Pandoc + wkhtmltopdf)

on:
  push:
    branches: [ main ]
    paths:
      - "AITL_Strategy_Proposal_Draft_v3.md"
      - "index.md"
      - "assets/css/**"
      - ".github/workflows/build-pdf.yml"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-pdf:
    runs-on: ubuntu-22.04
    timeout-minutes: 15
    env:
      DEBIAN_FRONTEND: noninteractive   # ← これで apt の対話止まりを回避
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Pandoc, wkhtmltopdf, and CJK fonts
        run: |
          set -eux
          sudo apt-get update -y
          sudo apt-get install -y --no-install-recommends \
            pandoc wkhtmltopdf \
            fonts-noto-cjk fonts-noto-cjk-extra fonts-noto-color-emoji

      - name: Ensure Figures directory
        run: mkdir -p Figures

      - name: Build PDF with Pandoc
        run: |
          set -eux
          pandoc AITL_Strategy_Proposal_Draft_v3.md \
            --from gfm \
            --pdf-engine=wkhtmltopdf \
            -V mainfont="Noto Sans CJK JP" \
            -V monofont="Noto Sans Mono CJK JP" \
            -V geometry:margin=20mm \
            -o Figures/AITL_Strategy_Proposal_Draft_v3.pdf

      - name: Commit PDF if changed
        run: |
          set -eux
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Figures/AITL_Strategy_Proposal_Draft_v3.pdf
          git commit -m "ci: update proposal PDF" || echo "No changes"
          git push

      - name: Upload artifact (optional)
        uses: actions/upload-artifact@v4
        with:
          name: AITL_Strategy_Proposal_Draft_v3.pdf
          path: Figures/AITL_Strategy_Proposal_Draft_v3.pdf
